{% extends 'base.html' %}

{% block title %}{{ survey_instance.name }}{% endblock %}

{% block content %}
<div class="w-100 my-5 px-0">
    <h1 class="display-4 text-primary text-center mb-4">{{ survey_instance.name }}</h1>
    
    <p class="lead text-center mb-5">{{ survey_instance.description }}</p>

    <form method="post" class="bg-white p-4 rounded shadow w-100 mx-0">
        {% csrf_token %}
        {% for field in form %}
            <div class="mb-4 text-start">
                <label for="{{ field.id_for_label }}" class="form-label fw-bold">{{ field.label }}</label>
                {{ field }}
                {% if field.field.widget.input_type == 'radio' %}
                    <div id="conditional-{{ field.name }}" class="conditional-field mt-3 d-none">
                        <div class="mb-3">
                            <label for="issue_{{ field.name }}" class="form-label">Please describe the issue:</label>
                            <textarea id="issue_{{ field.name }}" name="issue_{{ field.name }}" class="form-control" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="action_{{ field.name }}" class="form-label">What action was taken?</label>
                            <textarea id="action_{{ field.name }}" name="action_{{ field.name }}" class="form-control" rows="4" required></textarea>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="autofillAction('{{ field.name }}')">
                            Autofill: Contacted Team Leader / Manager
                        </button>
                    </div>
                {% endif %}
            </div>
        {% endfor %}

        <button type="submit" class="btn btn-success">Submit</button>
        <a href="{% url 'surveyapp:survey_list' %}" class="btn btn-danger ms-2">Discard Progress and Go Back to Surveys</a>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector("form");
        const radioButtons = document.querySelectorAll('input[type="radio"]');

        radioButtons.forEach(radio => {
            radio.addEventListener("change", function () {
                const questionName = this.name;
                const conditionalField = document.getElementById(`conditional-${questionName}`);
                const issueField = document.getElementById(`issue_${questionName}`);
                const actionField = document.getElementById(`action_${questionName}`);

                if (this.value === "No") {
                    conditionalField.classList.remove("d-none");
                    issueField.setAttribute("required", "true");
                    actionField.setAttribute("required", "true");
                } else {
                    conditionalField.classList.add("d-none");
                    issueField.removeAttribute("required");
                    actionField.removeAttribute("required");
                }
            });
        });
    });

    function autofillAction(fieldName) {
        const actionField = document.getElementById(`action_${fieldName}`);
        if (actionField) {
            actionField.value = "Contacted Team Leader / Manager";
        }
    }
</script>
{% endblock %}
